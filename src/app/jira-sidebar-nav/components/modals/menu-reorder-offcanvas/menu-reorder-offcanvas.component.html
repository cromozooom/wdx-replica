<!-- Menu Reorder Offcanvas -->
<div class="offcanvas-header border-bottom">
  <h5 class="offcanvas-title">Reorder Menu Items</h5>
  <button
    type="button"
    class="btn-close"
    aria-label="Close"
    (click)="cancel()"
  ></button>
</div>

<div class="offcanvas-body p-0 overflow-y-scroll">
  <div class="bg-info-subtle text-info-emphasis p-3 sticky-top">
    <i class="fas fa-info-circle me-2"></i>
    <strong>Drag and drop</strong> items to reorder. Drop position indicators:
    <!-- <ul class="mb-0 mt-2 small">
      <li><span class="text-primary">Top border</span> - Insert before</li>
      <li><span class="text-primary">Bottom border</span> - Insert after</li>
      <li><span class="text-primary">Full border</span> - Add as child</li>
    </ul> -->
  </div>

  <!-- Recursive Node Template -->
  <ng-template #tmplNode let-node="node">
    <div
      class="node-item"
      [attr.data-id]="node.id"
      [attr.id]="'node-' + node.id"
    >
      <div
        class="node-title px-2 py-3 my-2 rounded border"
        (click)="toggleExpansion(node)"
      >
        <span class="expansion-toggle me-3">
          @if (node.children?.length) {
            {{ node.expanded ? "âˆ’" : "+" }}
          } @else {
            &nbsp;&nbsp;&nbsp;
          }
        </span>
        <i [class]="node.icon || 'fas fa-circle'" class="me-3"></i>
        <span class="node-label">{{ node.label }}</span>
        @if (node.children?.length) {
          <span class="item-notes ms-2">
            ({{ node.children.length }}{{ node.expanded ? ", expanded" : "" }})
          </span>
        }
      </div>

      @if (node.expanded && node.children?.length) {
        <div
          class="node-children ms-2 mt-1 ps-2 border-start"
          cdkDropList
          [cdkDropListData]="node.children"
          [id]="node.id"
          [cdkDropListConnectedTo]="dropTargetIds"
          (cdkDropListDropped)="drop($event)"
          [cdkDropListSortingDisabled]="true"
        >
          @for (child of node.children; track child.id) {
            <div
              cdkDrag
              [cdkDragData]="child.id"
              (cdkDragMoved)="dragMoved($event)"
            >
              <ng-container
                *ngTemplateOutlet="tmplNode; context: { node: child }"
              ></ng-container>
            </div>
          }
        </div>
      }
    </div>
  </ng-template>

  <!-- Root Level Drop List -->
  <div
    cdkDropList
    [cdkDropListData]="menuItems"
    [id]="'main'"
    [cdkDropListConnectedTo]="dropTargetIds"
    (cdkDropListDropped)="drop($event)"
    [cdkDropListSortingDisabled]="true"
    class="root-drop-list px-2"
  >
    @for (node of menuItems; track node.id) {
      <div cdkDrag [cdkDragData]="node.id" (cdkDragMoved)="dragMoved($event)">
        <ng-container
          *ngTemplateOutlet="tmplNode; context: { node: node }"
        ></ng-container>
      </div>
    }
  </div>

  <!-- Debug Info (optional, can be removed) -->
  @if (dropActionTodo) {
    <div class="mt-3 p-2 bg-light border rounded small">
      <strong>Current drag action:</strong>
      <pre class="mb-0">{{ dropActionTodo | json }}</pre>
    </div>
  }
</div>

<div
  class="offcanvas-footer border-top p-2 d-flex gap-2 justify-content-between"
>
  <button type="button" class="btn btn-secondary" (click)="cancel()">
    Cancel
  </button>
  <button type="button" class="btn btn-primary" (click)="save()">
    Save Changes
  </button>
</div>
