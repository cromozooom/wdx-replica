<div class="spx-magic-selector">
  <!-- Selector Row with Dropdown and Advanced Lookup Button -->
  <div class="row g-2 align-items-start">
    <div class="col">
      <ng-select
        [items]="availableItems$ | async"
        bindLabel="name"
        [placeholder]="placeholder"
        [disabled]="disabled || readonly"
        [clearable]="!readonly"
        [searchable]="true"
        [(ngModel)]="selectedItem"
        (ngModelChange)="onSelectionChange($event)"
        (search)="onSearch($event.term)"
        notFoundText="No results found"
        class="w-100"
      >
        <ng-template ng-label-tmp let-item="item">
          <div class="d-flex align-items-center">
            <span
              class="badge me-2"
              [ngClass]="item.type === 'Form' ? 'bg-primary' : 'bg-success'"
            >
              {{ item.type }}
            </span>
            <span>{{ item.name }}</span>
          </div>
        </ng-template>

        <ng-template ng-option-tmp let-item="item" let-index="index">
          <div class="d-flex flex-column py-1">
            <div class="d-flex align-items-center mb-1">
              <span
                class="badge me-2"
                [ngClass]="item.type === 'Form' ? 'bg-primary' : 'bg-success'"
              >
                {{ item.type }}
              </span>
              <strong>{{ item.name }}</strong>
            </div>
            <div class="text-muted small ms-2">
              <span class="me-2">
                <i class="fa fa-database"></i> {{ item.entityName }}
              </span>
              <span *ngIf="item.queries?.length">
                <i class="fa fa-filter"></i> {{ item.queries.length }}
                {{ item.queries.length === 1 ? "query" : "queries" }}
              </span>
            </div>
            <div *ngIf="item.description" class="text-muted small ms-2 mt-1">
              {{ item.description }}
            </div>
          </div>
        </ng-template>

        <ng-template ng-notfound-tmp let-searchTerm="searchTerm">
          <div class="text-center text-muted p-3">
            <i class="fa fa-search mb-2"></i>
            <p class="mb-0">No results found for "{{ searchTerm }}"</p>
            <small>Try searching with different terms</small>
          </div>
        </ng-template>
      </ng-select>
    </div>

    <!-- Advanced Lookup Button -->
    <div class="col-auto">
      <button
        type="button"
        class="btn btn-outline-primary"
        (click)="openDiscoveryModal()"
        [disabled]="disabled"
        title="Open advanced lookup"
      >
        <i class="fa fa-th-list me-1"></i>
        Advanced
      </button>
    </div>
  </div>

  <!-- Preview Container -->
  <app-preview-container
    [selectedItem]="selectedItem$ | async"
    [selectedQuery]="selectedQuery$ | async"
    [showRecordCount]="true"
  >
  </app-preview-container>
</div>
