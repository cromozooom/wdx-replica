<div class="import-wizard-modal">
  <!-- Header -->
  <div class="modal-header">
    <h4 class="modal-title">
      Import Configurations
      @if (wizardStore.targetBasketId()) {
        <span class="text-muted small ms-2">
          → {{ getBasketName(wizardStore.targetBasketId()) }}
        </span>
      }
    </h4>
    <button
      type="button"
      class="btn-close"
      aria-label="Close"
      (click)="onClose()"
    ></button>
  </div>

  <!-- Body -->
  <div class="modal-body">
    <!-- Error Display -->
    @if (wizardStore.error()) {
      <div class="alert alert-danger" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        {{ wizardStore.error() }}
      </div>
    }

    <!-- File Upload (always visible when no conflicts) -->
    @if (!wizardStore.uploadedFile() || wizardStore.isProcessing()) {
      <div class="wizard-content">
        <div
          class="drop-zone"
          [class.drag-over]="isDragOver"
          (dragover)="onDragOver($event)"
          (dragleave)="onDragLeave($event)"
          (drop)="onDrop($event)"
        >
          @if (wizardStore.isProcessing()) {
            <div class="spinner-border text-primary mb-3" role="status">
              <span class="visually-hidden">Processing...</span>
            </div>
            <p>Processing ZIP file...</p>
          } @else {
            <i class="bi bi-cloud-upload fs-1 text-primary mb-3"></i>
            <p>Drag and drop ZIP file here</p>
            <p class="text-muted">or</p>
            <label for="file-input" class="btn btn-primary">
              <i class="bi bi-folder2-open me-2"></i>
              Browse Files
            </label>
          }
          <input
            type="file"
            id="file-input"
            accept=".zip"
            class="d-none"
            (change)="onFileSelect($event)"
          />
        </div>
      </div>
    }

    <!-- Conflict Review / Import Summary -->
    @if (wizardStore.uploadedFile() && !wizardStore.isProcessing()) {
      <div class="wizard-content">
        <!-- File Info -->
        <div class="uploaded-file-info mb-3">
          <div class="alert alert-info">
            <i class="bi bi-file-earmark-zip me-2"></i>
            <strong>{{ wizardStore.uploadedFile()!.name }}</strong>
            <span class="text-muted ms-2">
              ({{ (wizardStore.uploadedFile()!.size / 1024 / 1024).toFixed(2) }}
              MB,
              {{ wizardStore.importedConfigurations().length }} configurations)
            </span>
          </div>
        </div>
        @if (wizardStore.manifest()) {
          <div>Source Basket: {{ wizardStore.manifest()!.basketName }}</div>
          <div>
            Export Date:
            {{ wizardStore.manifest()!.exportDate | date }}
          </div>
        }
        <!-- Summary Stats -->
        <div class="import-summary mb-3">
          <div class="row text-center">
            <div class="col-4">
              <div class="stat-card">
                <div class="stat-label">Total</div>
                <div class="stat-value">
                  {{ wizardStore.importSummary().total }}
                </div>
              </div>
            </div>
            <div class="col-4">
              <div class="stat-card text-success">
                <div class="stat-label">Ready</div>
                <div class="stat-value">
                  {{ wizardStore.importSummary().noConflicts }}
                </div>
              </div>
            </div>
            <div class="col-4">
              <div class="stat-card text-warning">
                <div class="stat-label">Conflicts</div>
                <div class="stat-value">
                  {{ wizardStore.importSummary().conflicts }}
                </div>
              </div>
            </div>
          </div>
        </div>

        @if (wizardStore.importSummary().conflicts === 0) {
          <div class="alert alert-success">
            <i class="bi bi-check-circle-fill me-2"></i>
            All {{ wizardStore.importSummary().noConflicts }} configuration(s)
            are ready to import with no conflicts.
          </div>
        } @else {
          <!-- Conflict List -->
          <h6 class="mb-3">Configurations to Update:</h6>

          @if (wizardStore.importSummary().conflicts > 0) {
            <div class="mb-3">
              <label class="form-label small text-muted">Quick actions:</label>
              <div class="btn-group btn-group-sm" role="group">
                <button
                  type="button"
                  class="btn btn-outline-primary"
                  (click)="onResolveAll('overwrite')"
                >
                  <i class="bi bi-arrow-clockwise me-1"></i>
                  Overwrite All
                </button>
                <button
                  type="button"
                  class="btn btn-outline-secondary"
                  (click)="onResolveAll('keep')"
                >
                  <i class="bi bi-shield-check me-1"></i>
                  Keep All
                </button>
                <button
                  type="button"
                  class="btn btn-outline-success"
                  (click)="onResolveAll('import-as-new')"
                >
                  <i class="bi bi-plus-circle me-1"></i>
                  Import All as New
                </button>
              </div>
            </div>
          }

          <div class="conflict-list">
            @for (
              conflict of wizardStore.conflicts();
              track conflict.configId
            ) {
              @if (conflict.hasConflict) {
                <div class="conflict-item card mb-2">
                  <div class="card-body">
                    <div
                      class="d-flex justify-content-between align-items-start mb-2"
                    >
                      <div>
                        <h6 class="mb-1">{{ conflict.importedConfig.name }}</h6>
                        <div class="text-muted small">
                          ID: {{ conflict.configId }} • Type:
                          {{ conflict.importedConfig.type }}
                        </div>
                      </div>
                      <span class="badge bg-warning">Will Update</span>
                    </div>

                    <div class="conflict-details mb-2 small">
                      @if (conflict.differences.metadata.version) {
                        <div class="text-muted">
                          <i class="bi bi-tag me-1"></i>
                          Version:
                          {{ conflict.differences.metadata.version.existing }} →
                          {{ conflict.differences.metadata.version.imported }}
                        </div>
                      }
                      @if (conflict.differences.content.hasChanges) {
                        <div class="text-warning">
                          <i class="bi bi-exclamation-circle me-1"></i>
                          Content has changed
                        </div>
                      }
                    </div>

                    <button
                      type="button"
                      class="btn btn-sm btn-outline-info w-100"
                      (click)="onViewConflict(conflict)"
                    >
                      <i class="bi bi-eye me-1"></i>
                      View Differences
                    </button>
                  </div>
                </div>
              }
            }
          </div>
        }
      </div>
    }
  </div>

  <!-- Footer -->
  <div class="modal-footer">
    <button
      type="button"
      class="btn btn-secondary"
      (click)="onClose()"
      [disabled]="wizardStore.isProcessing()"
    >
      Cancel
    </button>

    @if (wizardStore.uploadedFile() && !wizardStore.isProcessing()) {
      <button
        type="button"
        class="btn btn-primary"
        (click)="onExecuteImport()"
        [disabled]="wizardStore.isProcessing()"
      >
        @if (wizardStore.isProcessing()) {
          <span class="spinner-border spinner-border-sm me-2"></span>
          Importing...
        } @else {
          <i class="bi bi-check-circle me-2"></i>
          Confirm Import
        }
      </button>
    }
  </div>
</div>
