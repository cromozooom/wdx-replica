<div class="modal-header px-0">
  <div class="d-flex justify-content-between align-items-center gap-3 w-100">
    <div>
      <h5 class="mb-0 ps-2">
        <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>
        Configuration Conflict: {{ conflict.importedConfig.name }}
      </h5>
    </div>
    <div class="d-flex justify-content-between align-items-center pe-3 gap-2">
      <div class="btn-group">
        <button
          type="button"
          class="btn btn-sm btn-outline-secondary"
          (click)="onPrevious()"
          [disabled]="!hasPrevious"
          title="Previous conflict"
        >
          <i class="fas fa-chevron-left"></i>
        </button>
        <span class="btn btn-sm btn-outline-secondary disabled">
          {{ currentIndex + 1 }} / {{ allConflicts.length }}
        </span>
        <button
          type="button"
          class="btn btn-sm btn-outline-secondary"
          (click)="onNext()"
          [disabled]="!hasNext"
          title="Next conflict"
        >
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
      <button
        type="button"
        class="btn-close"
        aria-label="Close"
        (click)="onClose()"
      ></button>
    </div>
  </div>
</div>

<div class="modal-body">
  <div class="conflict-comparison">
    <div class="alert alert-warning mb-3">
      <strong>Configuration ID:</strong> {{ conflict.configId }}
      <span class="ms-3"
        ><strong>Type:</strong> {{ conflict.importedConfig.type }}</span
      >
    </div>

    <!-- Metadata Changes -->
    @if (getMetadataChanges().length > 0) {
      <div class="metadata-section">
        <h6 class="section-title">Metadata Changes</h6>
        <div class="table-responsive">
          <table class="table table-sm table-bordered">
            <thead class="table-light">
              <tr>
                <th>Field</th>
                <th class="bg-danger bg-opacity-10">Existing</th>
                <th class="bg-success bg-opacity-10">Imported</th>
              </tr>
            </thead>
            <tbody>
              @for (change of getMetadataChanges(); track change.field) {
                <tr>
                  <td>
                    <strong>{{ change.field }}</strong>
                  </td>
                  <td class="existing-value">{{ change.existing }}</td>
                  <td class="imported-value">{{ change.imported }}</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    }

    <!-- Content Changes with Monaco Diff Viewer -->
    @if (conflict.differences.content.hasChanges) {
      <div class="content-section mb-4">
        <div class="diff-viewer-container">
          <div
            class="d-flex justify-content-center align-items-center gap-3 pb-2"
          >
            <span class="badge bg-danger-subtle text-danger-emphasis">
              <i class="bi bi-arrow-left me-1"></i>
              Existing Version
            </span>
            <span class="text-muted">vs</span>
            <span class="badge bg-success-subtle text-success-emphasis">
              <i class="bi bi-arrow-right me-1"></i>
              Imported Version
            </span>
          </div>
          <app-monaco-diff-viewer
            [leftValue]="
              getFormattedContent(conflict.differences.content.existing || '')
            "
            [rightValue]="
              getFormattedContent(conflict.differences.content.imported)
            "
            [language]="getMonacoLanguage(conflict.importedConfig.type)"
            style="min-height: 50vh; display: block"
          ></app-monaco-diff-viewer>
        </div>
      </div>
    } @else {
      <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>
        No content changes detected - only metadata differs.
      </div>
    }

    <!-- Basket Changes -->
    @if (conflict.differences.basket.hasChanges) {
      <div class="basket-section mb-4">
        <h6 class="section-title">
          <i class="bi bi-basket me-2"></i>
          Basket Assignment
        </h6>
        <div class="alert alert-info">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>Existing Basket:</strong>
              {{ conflict.differences.basket.existing || "None" }}
            </div>
            <div>
              <i class="bi bi-arrow-right mx-3"></i>
            </div>
            <div>
              <strong>Target Basket:</strong>
              {{ conflict.differences.basket.imported || "None" }}
            </div>
          </div>
        </div>
      </div>
    }
  </div>
</div>

<div class="modal-footer p-2">
  <div class="w-100 d-flex justify-content-between align-items-center">
    <div>
      <button (click)="onClose()" class="btn btn-link">Cancel</button>
    </div>
    <div class="btn-group" role="group">
      <button
        type="button"
        [class]="
          selectedStrategy === 'overwrite'
            ? 'btn btn-primary'
            : 'btn btn-outline-primary'
        "
        (click)="onResolve('overwrite')"
        title="Replace existing configuration with imported version"
      >
        Overwrite
      </button>
      <button
        type="button"
        [class]="
          selectedStrategy === 'keep'
            ? 'btn btn-primary'
            : 'btn btn-outline-primary'
        "
        (click)="onResolve('keep')"
        title="Keep existing configuration, skip import"
      >
        Keep Existing
      </button>
      <button
        type="button"
        [class]="
          selectedStrategy === 'import-as-new'
            ? 'btn btn-primary'
            : 'btn btn-outline-primary'
        "
        (click)="onResolve('import-as-new')"
        title="Import with a new ID"
      >
        Import as New
      </button>
    </div>
  </div>
</div>
